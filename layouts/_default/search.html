{{ define "main" }}
<input type="search" id="searchText"/>
<input type="button" value="検索"/>

<div id="result"></div>
{{- partialCached "hugo-search" . }}
<script>
    function inputHandler(event) {
        // IMEがオンでない場合を拾う
        if (event.isComposing === true) {
            return;
        }

        search(event);
    }

    function keyupHandler(event) {
        // Enterキーを拾う
        if (event.keyCode !== 13) {
            return;
        }

        search(event);
    }

    function search(event) {
        const text = event.target.value;
        if (text === "") {
            clearResults();
            return;
        }

        const pages = HugoIndexes.filter(function (page) {
            if (page.url.includes(text)) {
                return true;
            }

            if (page.title.includes(text)) {
                return true;
            }

            if (page.tags !== undefined && page.tags.includes(text)) {
                return true;
            }

            if (page.content.includes(text)) {
                return true;
            }
        });

        const count = pages.length;
        const pages100 = pages.slice(0, 100);
        writeResults(pages100, count);
    }

    function clearResults() {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "";
    }

    function writeResults(pages, count) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "";

        const countDiv = document.createElement("div");
        countDiv.textContent = count + "件ヒットしました。";
        resultDiv.appendChild(countDiv);

        pages.forEach(function (page) {
            const div = document.createElement("div");
            const a = document.createElement("a");
            a.href = page.url;
            a.textContent = page.title;

            div.appendChild(a);
            div.appendChild(document.createElement("br"));
            div.appendChild(document.createTextNode(page.content));
            div.appendChild(document.createElement("br"));
            div.appendChild(document.createElement("br"));

            resultDiv.appendChild(div);
        });
    }

    document.addEventListener('input', inputHandler);
    document.addEventListener('keyup', keyupHandler);
</script>
{{ end }}
